<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>日志测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .log-area {
      background-color: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      margin: 20px 0;
      height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      border-radius: 5px;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .info {
      margin: 10px 0;
      padding: 10px;
      background-color: #e9ecef;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>日志测试</h1>
    
    <div class="info">
      <p>程序ID: 1-fake_web_server</p>
      <p>日志类型: stdout</p>
    </div>
    
    <div class="controls">
      <button id="startBtn">开始获取日志</button>
      <button id="stopBtn" disabled>停止获取日志</button>
      <button id="clearBtn">清空日志</button>
    </div>
    
    <div class="log-area" id="logArea"></div>
    
    <div class="info">
      <p>日志行数: <span id="lineCount">0</span></p>
      <p>连接状态: <span id="connectionStatus">未连接</span></p>
    </div>
  </div>

  <!-- 引入Socket.io客户端 -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  
  <script>
    // 初始化变量
    let socket = null;
    let logLines = [];
    const logArea = document.getElementById('logArea');
    const lineCount = document.getElementById('lineCount');
    const connectionStatus = document.getElementById('connectionStatus');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const clearBtn = document.getElementById('clearBtn');
    
    // 更新日志显示
    function updateLogDisplay() {
      logArea.innerHTML = logLines.join('<br>');
      logArea.scrollTop = logArea.scrollHeight;
      lineCount.textContent = logLines.length;
    }
    
    // 处理日志块
    function handleLogChunk(data) {
      if (data.programId === '1-fake_web_server' && data.logType === 'stdout') {
        if (data.logs && data.logs.trim() !== '') {
          // 1. 移除所有控制字符
          // eslint-disable-next-line no-control-regex
          let logs = data.logs.replace(/[\x00-\x09\x0B-\x1F\x7F-\x9F]/g, '');
          // 2. 移除ANSI转义序列
          logs = logs.replace(/\u001B\[[^m]*m/g, '');
          // 3. 统一换行符
          logs = logs.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
          // 4. 移除每行前导空白
          logs = logs.replace(/^\s+/gm, '');
          // 5. 确保日志以换行符结束
          if (!logs.endsWith('\n')) {
            logs += '\n';
          }
          
          // 添加到日志数组
          const newLines = logs.split('\n').filter(line => line.trim() !== '');
          logLines = [...logLines, ...newLines];
          
          // 限制为500行
          const maxLogLines = 500;
          if (logLines.length > maxLogLines) {
            logLines = logLines.slice(logLines.length - maxLogLines);
          }
          
          updateLogDisplay();
        }
      }
    }
    
    // 开始获取日志
    startBtn.addEventListener('click', () => {
      if (socket) {
        socket.disconnect();
      }
      
      // 连接到Socket.io服务器
      socket = io('http://localhost:3000', {
        transports: ['polling', 'websocket'],
        timeout: 5000,
        reconnectionAttempts: 3
      });
      
      // 监听连接事件
      socket.on('connect', () => {
        console.log('Socket.io连接成功');
        connectionStatus.textContent = '已连接';
        connectionStatus.style.color = 'green';
        
        // 发送日志请求
        socket.emit('start_log_tail', {
          programId: '1-fake_web_server',
          logType: 'stdout',
          offset: -1
        });
        
        startBtn.disabled = true;
        stopBtn.disabled = false;
      });
      
      // 监听连接错误
      socket.on('connect_error', (error) => {
        console.error('Socket.io连接错误:', error);
        connectionStatus.textContent = `连接错误: ${error.message}`;
        connectionStatus.style.color = 'red';
      });
      
      // 处理日志块
      socket.on('log_chunk', handleLogChunk);
      
      // 处理错误
      socket.on('log_error', (data) => {
        if (data.programId === '1-fake_web_server' && data.logType === 'stdout') {
          const errorMessage = `[ERROR] ${data.error}`;
          logLines.push(errorMessage);
          updateLogDisplay();
        }
      });
      
      // 监听断开连接
      socket.on('disconnect', () => {
        console.log('Socket.io连接断开');
        connectionStatus.textContent = '已断开';
        connectionStatus.style.color = 'red';
        startBtn.disabled = false;
        stopBtn.disabled = true;
      });
    });
    
    // 停止获取日志
    stopBtn.addEventListener('click', () => {
      if (socket) {
        socket.emit('stop_log_tail');
        socket.disconnect();
        socket = null;
      }
      
      connectionStatus.textContent = '已停止';
      connectionStatus.style.color = 'orange';
      startBtn.disabled = false;
      stopBtn.disabled = true;
    });
    
    // 清空日志
    clearBtn.addEventListener('click', () => {
      logLines = [];
      updateLogDisplay();
    });
  </script>
</body>
</html>