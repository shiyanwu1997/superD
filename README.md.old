# Supervisor

## 项目介绍

这是一个基于 Supervisor 的进程管理平台，提供了友好的 Web 界面，方便运维和开发人员管理和监控通过 Supervisor 运行的程序。该平台支持多项目管理、程序状态监控、日志查看、批量操作等功能，并实现了完善的角色权限管理系统。

## 技术栈

### 前端
- React 18
- Vite 7
- React Router 7
- Ant Design 5
- Socket.io-client 4.8.3
- @xterm/xterm 6.0.0

### 后端
- Node.js
- Express 5.2.1
- Socket.io 4.8.3
- JWT 认证
- bcrypt 密码加密
- MySQL2 3.16.0
- xmlrpc 1.3.2

### 数据库
- MySQL 数据库（推荐生产环境）

## 功能特点

### 1. 角色权限管理系统 (RBAC)
- 基于角色的访问控制，分为三个层级：
  - **超级管理员**：仅admin用户可拥有此角色，拥有所有项目和用户的管理权限
  - **普通管理员**：可以创建普通用户，管理自己创建的用户和授权的项目
  - **普通用户**：无用户管理权限，只能访问被授权的项目和程序
- 权限动态检查，确保用户只能访问授权资源
- 密码使用 bcrypt 加密存储，保障安全性

### 2. 项目管理
- 项目列表展示，基于用户权限过滤
- 项目连接状态实时显示（在线/离线/检查中）
- 支持多项目管理，可切换查看不同项目的程序

### 3. 程序管理
- 实时监控程序运行状态（运行中、已停止、启动中、异常等）
- 单个程序操作：启动、停止、重启
- 批量操作：启动所有、停止所有、重启所有程序
- 程序搜索功能，快速定位目标程序

### 4. 日志管理
- 支持查看标准输出日志（stdout）和标准错误日志（stderr）
- 实时日志更新，支持自动滚动查看
- 日志终端化展示，提供更好的阅读体验
- 支持大量日志的高效加载和显示

### 5. 用户管理
- 用户列表展示，支持按角色过滤
- 支持创建、删除、修改用户信息
- 支持修改用户密码
- 支持查看用户创建的历史记录

### 6. 界面优化
- 响应式设计，适配不同屏幕尺寸
- 清晰的布局结构，操作流程直观
- 实时的操作反馈，提升用户体验
- 所有ID（角色ID、上级管理员ID等）均转换为对应名称显示，不直接显示数字ID

## 安装和使用

### 环境要求
- Node.js 16+
- npm 或 yarn
- MySQL 数据库（可选，生产环境推荐）
- Supervisor 已安装并运行

### 安装步骤

1. 克隆项目
```bash
git clone <项目地址>
cd supervisor-v1
```

2. 后端安装与配置
```bash
# 进入后端目录
cd backend

# 安装后端依赖
npm install

# 配置环境变量（可选，建议创建 .env 文件）
# 示例：创建 .env 文件并添加以下内容
# PORT=3000
# STORAGE_TYPE=mysql
# MYSQL_HOST=127.0.0.1
# MYSQL_PORT=3306
# MYSQL_USER=root
# MYSQL_PASSWORD=your_password
# MYSQL_DATABASE=supervisor

# 返回项目根目录
cd ..
```

3. 前端安装与配置
```bash
# 进入前端目录
cd client

# 安装前端依赖
npm install

# 返回项目根目录
cd ..
```

### 构建与启动

#### 前端构建
```bash
cd client
npm run build
cd ..
```

#### 后端构建
```bash
cd backend
npm run build
cd ..
```

#### 启动方式

**方式1：单独启动后端服务**
```bash
cd backend
npm run start
```

**方式2：单独启动前端开发服务器**
```bash
cd client
npm run dev
```

**方式3：使用PM2启动（推荐生产环境）**

1. 安装PM2
```bash
npm install -g pm2
```

2. 构建前端项目
```bash
cd client
npm run build
cd ..
```

3. 使用PM2配置文件启动
```bash
npm install -g serve
cd client
npm install
npm run build
cd ..

cd backend
npm install
cd ..

npm install -g pm2
npm run start-pm2
```

或者直接使用PM2启动配置文件：
```bash
npm install -g serve pm2

# 构建前端
cd client
npm install
npm run build
cd ..

# 安装后端依赖
cd backend
npm install
cd ..

# 启动服务
npm run start-pm2
```

## 项目结构

```
supervisor-v1/
├── backend/               # 后端代码
│   ├── logs/              # 日志文件
│   │   ├── access.log            # 访问日志
│   │   └── error.log             # 错误日志
│   ├── middleware/        # 中间件
│   │   └── auth.js               # 认证中间件
│   ├── models/            # 数据模型
│   │   ├── db.js                 # 数据库操作封装
│   │   └── db.mysql.js           # MySQL 数据库实现
│   ├── routes/            # 后端路由
│   │   └── index.js              # 路由配置
│   ├── scripts/           # 脚本工具
│   │   └── encrypt-project-passwords.js # 项目密码加密工具
│   ├── services/          # 业务逻辑
│   │   ├── supervisorService.js  # Supervisor 服务封装
│   │   └── socketServer.js       # Socket.IO 实时通信服务
│   ├── test/              # 测试代码
│   │   ├── db.mysql.test.js      # MySQL 数据库测试
│   │   └── db.test.js            # 数据库测试
│   ├── utils/             # 工具函数
│   │   ├── errors.js             # 错误处理
│   │   └── logger.js             # 日志工具
│   ├── app.js             # 后端入口
│   ├── config.js          # 配置文件
│   ├── init-db.js         # 数据库初始化脚本
│   ├── package-lock.json  # 后端依赖锁文件
│   └── package.json       # 后端依赖配置
├── client/                # 前端代码
│   ├── dist/             # 构建输出
│   │   ├── assets/               # 静态资源
│   │   └── index.html            # 入口HTML
│   ├── public/           # 公共资源
│   ├── src/              # 源代码
│   │   ├── assets/       # 静态资源
│   │   ├── components/   # 组件
│   │   │   ├── modals/           # 模态框组件
│   │   │   ├── users/            # 用户管理组件
│   │   │   └── LogTerminal.jsx   # 日志终端组件
│   │   ├── contexts/     # React 上下文
│   │   │   └── AuthContext.jsx   # 认证上下文
│   │   ├── pages/        # 页面组件
│   │   │   ├── LoginPage.jsx     # 登录页面
│   │   │   ├── ProgramsPage.jsx  # 程序列表页面
│   │   │   ├── ProgramDetailPage.jsx # 程序详情页面
│   │   │   └── UsersPage.jsx     # 用户管理页面
│   │   ├── utils/        # 工具函数
│   │   │   └── api.js            # API 调用封装
│   │   ├── App.css       # 全局样式
│   │   ├── App.jsx       # 应用入口
│   │   └── main.jsx      # 主入口文件
│   ├── .gitignore        # Git 忽略文件
│   ├── eslint.config.js  # ESLint 配置
│   ├── index.html        # HTML 模板
│   ├── package-lock.json # 前端依赖锁文件
│   ├── package.json      # 前端依赖配置
│   └── vite.config.js    # Vite 配置
├── .env.example          # 环境变量示例
├── API_SPEC.md           # API接口文档
├── API接口列表.md        # API接口列表（表格形式）
├── ecosystem.config.js   # PM2 配置文件
├── package-lock.json     # 根目录依赖锁文件
├── package.json          # 根目录依赖配置
└── README.md             # 项目说明文档
```

## 环境变量配置

### 后端环境变量
在 `backend` 目录下创建 `.env` 文件，配置以下环境变量：

```env
PORT=3000
STORAGE_TYPE=mysql
SESSION_SECRET=your_session_secret

# MySQL 数据库配置
MYSQL_HOST=127.0.0.1
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=your_password
MYSQL_DATABASE=supervisor
```

### 前端环境变量
在 `client` 目录下创建 `.env` 文件，配置以下环境变量：

```env
VITE_API_URL=http://localhost:3000
```

## API 接口

### 认证相关
- `POST /api/login` - 用户登录，返回JWT令牌
- `GET /api/user` - 获取当前用户信息

### 项目相关
- `GET /api/projects` - 获取项目列表（基于当前用户权限）
- `GET /api/projects/:projectId/status` - 检查项目连接状态
- `POST /api/projects` - 创建新项目（需要管理员权限）
- `PUT /api/projects/:id` - 更新项目信息（需要管理员权限）
- `DELETE /api/projects/:id` - 删除项目（需要管理员权限）

### 程序相关
- `GET /api/projects/:projectId/programs` - 获取项目下的程序列表
- `GET /api/programs/:programId` - 获取程序详情
- `POST /api/programs/:programId/start` - 启动程序
- `POST /api/programs/:programId/stop` - 停止程序
- `POST /api/programs/:programId/restart` - 重启程序

### 批量操作
- `POST /api/projects/:projectId/programs/start-all` - 启动所有程序
- `POST /api/projects/:projectId/programs/stop-all` - 停止所有程序
- `POST /api/projects/:projectId/programs/restart-all` - 重启所有程序

### 日志相关
- `GET /api/programs/:programId/stdout` - 获取标准输出日志
- `GET /api/programs/:programId/stderr` - 获取标准错误日志
- **Socket.IO** - 实时日志推送

### 用户管理
- `GET /api/users` - 获取用户列表（基于当前用户权限）
- `POST /api/users` - 创建新用户（需要管理员权限）
- `DELETE /api/users/:userId` - 删除用户（需要管理员权限）
- `PUT /api/users/:userId/role` - 更新用户角色（需要管理员权限）
- `PUT /api/users/self/password` - 修改当前用户密码
- `PUT /api/users/:userId/password` - 修改指定用户密码（需要管理员权限）
- `GET /api/roles` - 获取所有角色

## 注意事项

1. **角色权限说明**：
   - 超级管理员（roleId=1）：拥有所有权限，可创建普通管理员和普通用户
   - 普通管理员（roleId=2）：只能创建普通用户，管理自己创建的用户
   - 普通用户（roleId=3）：无用户管理权限

2. **项目启动注意事项**：
   - 确保 MySQL 数据库已启动并配置正确
   - 首次启动会自动创建数据库和表结构
   - 首次启动会自动生成超级管理员账号：admin / admin123
   - Supervisor 服务需要在后台运行，并配置允许远程访问

3. **构建说明**：
   - 前端和后端均支持独立执行 `npm run build` 命令
   - 前端构建后生成静态文件，可使用任意静态文件服务器部署
   - 后端构建目前仅输出提示信息，无需编译

4. **数据库连接**：
   - 系统已实现数据库连接重试机制，数据库重启后会自动重新连接
   - 建议在生产环境使用 MySQL 数据库，提供更好的性能和可靠性

## 开发说明

### 前端开发
```bash
cd client
npm run dev
```

### 后端开发
```bash
cd backend
npm run start
```

### 代码检查
```bash
# 前端代码检查
cd client
npm run lint

# 后端代码检查
cd backend
npm run lint
```

## License

MIT
